# Rocketpass Starterpack - Technical Documentation

This project is a SaaS starter pack that includes authentication, authorization, multi-tenancy, admin panel, and API documentation foundations.

## Components and Gems

- Devise (+ JWT, Invitable): authentication, invitations
- Pundit: policy-based authorization
- Rolify + Permission: flexible role/permission model
- ActsAsTenant: multi-tenancy (Account-based)
- Administrate: admin panel
- Blueprinter: safe and fast JSON serialization
- RSwag (API + UI + Specs): Swagger/OpenAPI documentation
- Rack CORS: frontend/mobile client access
- Doorkeeper: OAuth2 provider
- Pagy: pagination
- Ransack: advanced filtering
- pg_search: Postgres full-text search
- Sidekiq: background jobs
- sidekiq-scheduler: cron/scheduled jobs
- Redis: for Sidekiq and cache
- AASM: state machine
- Active Storage: file/media upload
- active_storage_validations: Active Storage validations
- image_processing: image processing (mini_magick/vips)
- aws-sdk-s3: S3 storage support

## API Architecture

- `Api::V1::BaseController`: auth + tenant scoping + Pundit
- `Api::V1::ResourceController`: CRUD template
  - `index`: Ransack (`q`), full-text (`search`), and Pagy pagination
  - `show`, `create`, `update`, `destroy`
  - Configured via class attributes: `resource_model`, `resource_blueprint`
  - `resource_params` must be defined by the child controller

Example: `ProfilesController` → `resource_model = Profile`, `resource_blueprint = ProfileBlueprint`

## Background Jobs

- Sidekiq Web: `/admin/sidekiq` (requires admin role)
- Config: `config/sidekiq.yml`, initializer `config/initializers/sidekiq.rb`
- Example workers: `TaskProcessWorker`, `CleanupFailedTasksWorker` (scheduler runs daily at 03:00)

## AASM

- Example state machine on `Task`: `draft → queued → in_progress → completed` (error: `failed`)
- Trigger event: `POST /api/v1/tasks/{id}/event` with payload `{ event: "queue" }`

## Swagger / OpenAPI

- UI: `/api-docs`
- Schema: `swagger/v1/openapi.yaml`
- Generated by RSpec + rswag-specs
  - Tests: `bundle exec rspec`
  - Generate Swagger: `bundle exec rake rswag:specs:swaggerize`

## File & Media Uploads

- Local storage: `config/storage.yml -> local`
- S3: `config/storage.yml -> amazon` (ENV: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION`, `AWS_S3_BUCKET`)
- Default service: set in `config/environments/*.rb` via `config.active_storage.service = :local` (or `:amazon`)

Validations
- Profile avatar: max 5MB, content-type image (png/jpg/jpeg/webp)
- Task attachments: max 20MB; image/pdf

API Endpoints (Uploads)
- `POST /api/v1/profiles/{id}/avatar` (multipart form-data, `file`)
- `DELETE /api/v1/profiles/{id}/avatar`
- `POST /api/v1/tasks/{id}/attachments` (multipart, `files[]`)
- `DELETE /api/v1/tasks/{id}/attachments/{attachment_id}`

Image Processing
- In `ProfileBlueprint`, `avatar_thumb_url` uses `resize_to_limit: [200,200]`

## OAuth2 (Doorkeeper)

- Endpoints under `/oauth/*` (applications, tokens)
- Resource owner password flow supported (email + password)

## CORS

- `config/initializers/cors.rb` → development allows `origins '*'`; restrict by domain in production

## Pagination

- Pagy default: 20 per page; metadata returned under `meta`

## Search/Filtering

- Ransack: use `q` param for column-based queries
- Full-text: use `search` param with `pg_search` scope (`search_text`)

## Extending

For a new model:
1) Model and migration (prefer `account_id` with `acts_as_tenant :account`)
2) Blueprint (JSON projection)
3) Controller: inherit from `Api::V1::ResourceController` and set `resource_model`, `resource_blueprint`, `resource_params`
4) Route: `resources :new_resource`
5) Swagger: add `spec/requests/..._spec.rb` and/or update `swagger/v1/openapi.yaml`

## Service Layer

- Location: `app/services`
- Base class: `ApplicationService` with `.call` shortcut and `success/failure`
- Result object: `Service::Result` (`success?`, `failure?`, `value`, `error`, `code`)
- Generic CRUD services: `Resources::CreateService`, `Resources::UpdateService`, `Resources::DestroyService`
- Examples: `Profiles::UpdateAvatarService`, `Users::InviteService`
- Controllers integrate by checking `result.success?` and rendering `result.value` or `result.error`

## Internationalization (I18n)

- Locales: English (`en`) and Turkish (`tr`)
- Selection priority: `current_user.locale` → `X-Locale` header / `?locale` param → default `:en`
- Translation files: `config/locales/en.yml`, `config/locales/tr.yml`, `config/locales/activerecord.*.yml`
- Model validations leverage Rails I18n; custom attributes and messages provided for Profile
- Flash messages and service errors use I18n keys

## Service Layer (Details)

Use services to extract reusable business rules out of controllers/models and share the same logic across API and web flows.

- Location: `app/services`
- Base class: `ApplicationService` with `.call` shortcut and `success`/`failure` helpers
- Result object: `Service::Result` (`success?`, `failure?`, `value`, `error`, `code`)

Examples
- Profile avatar update: `Profiles::UpdateAvatarService`
  - With file: `Profiles::UpdateAvatarService.call(profile: p, file: params[:file])`
  - With signed ID: `Profiles::UpdateAvatarService.call(profile: p, signed_id: params[:signed_id])`
  - Purge: `Profiles::UpdateAvatarService.call(profile: p, purge: true)`
- Send invitation (Admin): `Users::InviteService.call(email: ..., inviter: current_user)`

Controller Integration
- On success: use `result.value` when `result.success?`
- On error: `render_errors(result.error, status: result.code || :unprocessable_entity)`

Naming Guidelines
- Prefer `Domain::ActionService` or `Domain::Action` (e.g., `Users::InviteService`, `Tasks::ProcessAttachment`)
- Keep services single-purpose with minimal side effects.
